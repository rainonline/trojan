# æµé‡æœˆåº¦è‡ªåŠ¨é‡ç½®åŠŸèƒ½ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

### ç”¨æˆ·æŠ¥å‘Š
> "ç”¨æˆ·æµé‡ç”¨é‡æ¯æœˆè‡ªåŠ¨é‡ç½®çš„åŠŸèƒ½ä¸æ­£å¸¸"

### ç—‡çŠ¶
1. éƒ¨åˆ†ç”¨æˆ·çš„æµé‡åœ¨æ¯æœˆæŒ‡å®šæ—¥æœŸä¸ä¼šè‡ªåŠ¨é‡ç½®
2. åªæœ‰è®¾ç½®äº†æœ‰æ•ˆæœŸï¼ˆuseDays != 0ï¼‰çš„ç”¨æˆ·æµé‡æ‰ä¼šè¢«é‡ç½®
3. æœªè®¾ç½®æœ‰æ•ˆæœŸä½†æœ‰æµé‡é™é¢çš„ç”¨æˆ·æµé‡ä¸€ç›´ä¸ä¼šé‡ç½®

### å½±å“èŒƒå›´
- **å½±å“åŠŸèƒ½**: æœˆåº¦æµé‡è‡ªåŠ¨é‡ç½®
- **å½±å“ç”¨æˆ·**: æ‰€æœ‰ `useDays = 0` ä¸” `quota != 0` çš„ç”¨æˆ·
- **å½±å“ç‰ˆæœ¬**: æ‰€æœ‰ç‰ˆæœ¬
- **ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½å¤±æ•ˆï¼‰

---

## ğŸ” é—®é¢˜è¯Šæ–­

### 1. é—®é¢˜å®šä½

é€šè¿‡ä»£ç å®¡æŸ¥å‘ç° `core/mysql.go` ä¸­çš„ `MonthlyResetData()` å‡½æ•°å­˜åœ¨é€»è¾‘é”™è¯¯ï¼š

```go
// é—®é¢˜ä»£ç ï¼šcore/mysql.go Line 318
func (mysql *Mysql) MonthlyResetData() error {
    db := mysql.GetDB()
    if db == nil {
        return errors.New("can't connect mysql")
    }
    // âŒ é”™è¯¯çš„ SQL æŸ¥è¯¢æ¡ä»¶
    userList, err := queryUserList(db, "SELECT * FROM users WHERE useDays != 0 AND quota != 0")
    // ...
}
```

### 2. æ ¹æœ¬åŸå› 

**é”™è¯¯çš„ SQL æŸ¥è¯¢æ¡ä»¶**:
```sql
SELECT * FROM users WHERE useDays != 0 AND quota != 0
```

è¿™ä¸ªæŸ¥è¯¢åªä¼šé€‰æ‹©**åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶**çš„ç”¨æˆ·ï¼š
1. `useDays != 0` - è®¾ç½®äº†æœ‰æ•ˆæœŸ
2. `quota != 0` - æœ‰æµé‡é™é¢

**é—®é¢˜åˆ†æ**:

| ç”¨æˆ·ç±»å‹ | useDays | quota | æ˜¯å¦é‡ç½®æµé‡ï¼ˆä¿®å¤å‰ï¼‰ | æ˜¯å¦åº”è¯¥é‡ç½® |
|---------|---------|-------|------------------|-------------|
| æ°¸ä¹…ç”¨æˆ·ï¼ˆæ— é™æœŸï¼‰ | 0 | 1000 | âŒ **ä¸é‡ç½®** | âœ… åº”è¯¥é‡ç½® |
| é™æœŸç”¨æˆ· | 30 | 1000 | âœ… é‡ç½® | âœ… åº”è¯¥é‡ç½® |
| æ— é™é¢ç”¨æˆ· | 0 | 0 | âŒ ä¸é‡ç½® | âŒ ä¸éœ€è¦é‡ç½® |
| è¿‡æœŸç”¨æˆ· | 30 | 0 | âŒ ä¸é‡ç½® | âŒ ä¸éœ€è¦é‡ç½® |

**æ ¸å¿ƒé—®é¢˜**: æ°¸ä¹…ç”¨æˆ·ï¼ˆ`useDays = 0`ï¼‰çš„æµé‡æ°¸è¿œä¸ä¼šè¢«é‡ç½®ï¼

### 3. ä¸šåŠ¡é€»è¾‘åˆ†æ

**useDays å­—æ®µçš„å«ä¹‰**:
- `useDays = 0`: æ°¸ä¹…æœ‰æ•ˆï¼Œæ— è¿‡æœŸæ—¶é—´
- `useDays > 0`: é™æœŸç”¨æˆ·ï¼Œæœ‰è¿‡æœŸæ—¶é—´

**quota å­—æ®µçš„å«ä¹‰**:
- `quota = 0`: æ— æµé‡é™é¢ï¼ˆé€šå¸¸æ˜¯è¿‡æœŸç”¨æˆ·æˆ–è¢«ç¦ç”¨ï¼‰
- `quota > 0`: æœ‰æµé‡é™é¢ï¼ˆæ­£å¸¸ä½¿ç”¨çš„ç”¨æˆ·ï¼‰

**æ­£ç¡®çš„é‡ç½®é€»è¾‘**:
- æœˆåº¦æµé‡é‡ç½®åº”è¯¥é’ˆå¯¹**æ‰€æœ‰æœ‰æµé‡é™é¢çš„ç”¨æˆ·**ï¼ˆ`quota != 0`ï¼‰
- **ä¸åº”è¯¥ä¾èµ–** `useDays` å­—æ®µï¼ˆæœ‰æ•ˆæœŸä¸æµé‡é‡ç½®æ— å…³ï¼‰

### 4. å½±å“ç¤ºä¾‹

å‡è®¾ç³»ç»Ÿä¸­æœ‰ä»¥ä¸‹ç”¨æˆ·ï¼š

| ç”¨æˆ·å | useDays | quota | download | upload | ä¿®å¤å‰ | ä¿®å¤å |
|-------|---------|-------|----------|--------|-------|-------|
| alice | 0 | 1000 | 500 | 300 | âŒ ä¸é‡ç½®ï¼ˆ800ï¼‰ | âœ… é‡ç½®ä¸º 0 |
| bob | 30 | 1000 | 600 | 400 | âœ… é‡ç½®ä¸º 0 | âœ… é‡ç½®ä¸º 0 |
| charlie | 0 | 0 | 100 | 50 | âŒ ä¸é‡ç½® | âŒ ä¸é‡ç½® |
| david | 30 | 0 | 50 | 50 | âŒ ä¸é‡ç½® | âŒ ä¸é‡ç½® |

**ç»“æœ**: åªæœ‰ alice ä¼šå—åˆ°æ­¤æ¬¡ä¿®å¤çš„å½±å“ï¼ˆä¹‹å‰æµé‡ä¸ä¼šé‡ç½®ï¼Œä¿®å¤åä¼šæ­£å¸¸é‡ç½®ï¼‰ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ä»£ç ä¿®å¤

**æ–‡ä»¶**: `core/mysql.go`

**ä¿®æ”¹å†…å®¹**:

```diff
-// MonthlyResetData è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ç”¨æˆ·ï¼Œæ¯æœˆå®šæ—¶æ¸…ç©ºä½¿ç”¨æµé‡
+// MonthlyResetData æ¯æœˆå®šæ—¶æ¸…ç©ºæ‰€æœ‰æœ‰æµé‡é™é¢ç”¨æˆ·çš„ä½¿ç”¨æµé‡
 func (mysql *Mysql) MonthlyResetData() error {
 	db := mysql.GetDB()
 	if db == nil {
 		return errors.New("can't connect mysql")
 	}
-	userList, err := queryUserList(db, "SELECT * FROM users WHERE useDays != 0 AND quota != 0")
+	// ä¿®å¤ï¼šé‡ç½®æ‰€æœ‰æœ‰æµé‡é™é¢çš„ç”¨æˆ·ï¼Œä¸åº”è¯¥ä¾èµ– useDays æ¡ä»¶
+	// åŸé€»è¾‘ "useDays != 0 AND quota != 0" å¯¼è‡´æœªè®¾ç½®æœ‰æ•ˆæœŸçš„ç”¨æˆ·æµé‡ä¸ä¼šé‡ç½®
+	userList, err := queryUserList(db, "SELECT * FROM users WHERE quota != 0")
 	if err != nil {
 		return err
 	}
```

**å…³é”®å˜æ›´**:
1. ç§»é™¤ `useDays != 0` æ¡ä»¶
2. åªä¿ç•™ `quota != 0` æ¡ä»¶
3. æ›´æ–°å‡½æ•°æ³¨é‡Šè¯´æ˜
4. æ·»åŠ ä¿®å¤åŸå› è¯´æ˜

### 2. ä¿®å¤å‰åå¯¹æ¯”

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| SQL æŸ¥è¯¢ | `WHERE useDays != 0 AND quota != 0` | `WHERE quota != 0` |
| é‡ç½®èŒƒå›´ | ä»…é™æœŸç”¨æˆ· | æ‰€æœ‰æœ‰æµé‡é™é¢çš„ç”¨æˆ· |
| æ°¸ä¹…ç”¨æˆ· | âŒ ä¸é‡ç½® | âœ… é‡ç½® |
| é™æœŸç”¨æˆ· | âœ… é‡ç½® | âœ… é‡ç½® |
| æ— é™é¢ç”¨æˆ· | âŒ ä¸é‡ç½® | âŒ ä¸é‡ç½® |
| ä¸šåŠ¡é€»è¾‘ | âŒ é”™è¯¯ | âœ… æ­£ç¡® |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

**è„šæœ¬ä½ç½®**: `scripts/test-monthly-reset.sh`

**æµ‹è¯•æµç¨‹**:
```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
./scripts/test-monthly-reset.sh http://localhost:8080 admin yourPassword

# è„šæœ¬ä¼šè‡ªåŠ¨æ‰§è¡Œï¼š
#   1. ç®¡ç†å‘˜ç™»å½•
#   2. è·å–å½“å‰é‡ç½®æ—¥é…ç½®
#   3. è·å–ç”¨æˆ·åˆ—è¡¨
#   4. è·å–å®šæ—¶ä»»åŠ¡ç»Ÿè®¡
#   5. éªŒè¯ monthly_reset ä»»åŠ¡å·²æ³¨å†Œ
#   6. æµ‹è¯•ä¿®æ”¹é‡ç½®æ—¥
#   7. éªŒè¯ä»»åŠ¡åŠ¨æ€æ›´æ–°
#   8. æ¢å¤åŸé…ç½®
```

### 2. æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

#### æµ‹è¯•å‰å‡†å¤‡

```bash
# 1. æŸ¥çœ‹å½“å‰ç”¨æˆ·æµé‡çŠ¶æ€
mysql -u root -p trojan -e "SELECT id, username, useDays, quota, download, upload FROM users;"

# 2. è®°å½• useDays=0 ä¸” quota!=0 çš„ç”¨æˆ·
```

#### æ‰§è¡Œæµ‹è¯•

**æ–¹æ³• A: æ‰‹åŠ¨è§¦å‘é‡ç½®ï¼ˆæ¨èç”¨äºæµ‹è¯•ï¼‰**

```bash
# 1. ç™»å½•ç®¡ç†åå°
curl -X POST http://localhost:8080/auth/login \
  -d "username=admin&password=yourPassword"
# è®°å½•è¿”å›çš„ token

# 2. æ‰‹åŠ¨è°ƒç”¨é‡ç½®å‡½æ•°ï¼ˆé€šè¿‡ MySQL ç›´æ¥éªŒè¯ï¼‰
mysql -u root -p trojan <<EOF
-- æŸ¥çœ‹ä¿®å¤å‰çš„ SQL ç»“æœï¼ˆåº”è¯¥åªåŒ…å« useDays!=0 çš„ç”¨æˆ·ï¼‰
SELECT id, username, useDays, quota, download, upload 
FROM users 
WHERE useDays != 0 AND quota != 0;

-- æŸ¥çœ‹ä¿®å¤åçš„ SQL ç»“æœï¼ˆåº”è¯¥åŒ…å«æ‰€æœ‰ quota!=0 çš„ç”¨æˆ·ï¼‰
SELECT id, username, useDays, quota, download, upload 
FROM users 
WHERE quota != 0;
EOF

# 3. é‡å¯æœåŠ¡åº”ç”¨ä¿®å¤
docker-compose restart trojan
# æˆ–
systemctl restart trojan-web

# 4. ç­‰å¾…ä¸‹æ¬¡è‡ªåŠ¨é‡ç½®ï¼ˆæŒ‰é…ç½®çš„é‡ç½®æ—¥ï¼‰
# æˆ–æ‰‹åŠ¨æ‰§è¡Œ CLI å‘½ä»¤æµ‹è¯•
trojan clean <username>
```

**æ–¹æ³• B: ä¿®æ”¹é‡ç½®æ—¥å¿«é€Ÿæµ‹è¯•**

```bash
# 1. ç™»å½•è·å– token
TOKEN=$(curl -s -X POST http://localhost:8080/auth/login \
  -d "username=admin&password=yourPassword" | jq -r '.token')

# 2. æŸ¥çœ‹å½“å‰é‡ç½®æ—¥
curl -s -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/trojan/data/resetDay | jq .

# 3. è®¾ç½®é‡ç½®æ—¥ä¸ºæ˜å¤©
TOMORROW_DAY=$(date -v+1d +%d)
curl -X POST -H "Authorization: Bearer $TOKEN" \
  -d "day=$TOMORROW_DAY" \
  http://localhost:8080/trojan/data/resetDay

# 4. éªŒè¯ä»»åŠ¡å·²æ›´æ–°
curl -s -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/common/tasks/stats | jq '.Data[] | select(.name == "monthly_reset")'

# 5. ç­‰å¾…æ˜å¤©è‡ªåŠ¨é‡ç½®ï¼Œç„¶åæ£€æŸ¥ç”¨æˆ·æµé‡
mysql -u root -p trojan -e "SELECT id, username, useDays, quota, download, upload FROM users WHERE quota != 0;"
```

### 3. éªŒè¯æ ‡å‡†

æµ‹è¯•é€šè¿‡éœ€è¦æ»¡è¶³ï¼š

| éªŒè¯é¡¹ | éªŒè¯æ–¹æ³• | é¢„æœŸç»“æœ |
|--------|---------|---------|
| SQL æŸ¥è¯¢ä¿®å¤ | ä»£ç å®¡æŸ¥ | âœ… ç§»é™¤ useDays != 0 æ¡ä»¶ |
| ä»»åŠ¡æ³¨å†Œ | GET /common/tasks/stats | âœ… monthly_reset å­˜åœ¨ |
| Cron è¡¨è¾¾å¼ | æ£€æŸ¥ spec | âœ… `0 0 <day> * *` |
| æ°¸ä¹…ç”¨æˆ·é‡ç½® | æ•°æ®åº“æŸ¥è¯¢ | âœ… useDays=0 ç”¨æˆ·æµé‡è¢«é‡ç½® |
| é™æœŸç”¨æˆ·é‡ç½® | æ•°æ®åº“æŸ¥è¯¢ | âœ… useDays!=0 ç”¨æˆ·æµé‡è¢«é‡ç½® |
| æ— é™é¢ç”¨æˆ· | æ•°æ®åº“æŸ¥è¯¢ | âœ… quota=0 ç”¨æˆ·æµé‡ä¸å—å½±å“ |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å¤‡ä»½æ•°æ®

```bash
# å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p trojan > trojan_backup_$(date +%Y%m%d).sql

# å¤‡ä»½ä»£ç 
cp core/mysql.go core/mysql.go.backup
```

### 2. éƒ¨ç½²æ–°ç‰ˆæœ¬

#### Docker æ–¹å¼
```bash
cd /path/to/trojan

# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin master

# 2. é‡å»ºé•œåƒ
docker-compose build trojan

# 3. é‡å¯æœåŠ¡
docker-compose restart trojan

# 4. éªŒè¯æœåŠ¡
docker-compose logs -f trojan | grep "monthly_reset"
```

#### ç‰©ç†æœºæ–¹å¼
```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
cd /path/to/trojan
git pull origin master

# 2. ç¼–è¯‘æ–°ç‰ˆæœ¬
go build -o trojan .

# 3. æ›¿æ¢äºŒè¿›åˆ¶æ–‡ä»¶
cp trojan /usr/local/bin/trojan

# 4. é‡å¯æœåŠ¡
systemctl restart trojan-web

# 5. éªŒè¯æœåŠ¡
journalctl -u trojan-web -f | grep "monthly_reset"
```

### 3. éªŒè¯éƒ¨ç½²

```bash
# è¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•
./scripts/test-monthly-reset.sh http://localhost:8080 admin yourPassword

# æ£€æŸ¥ä»»åŠ¡æ˜¯å¦æ­£å¸¸æ³¨å†Œ
curl -H "Authorization: Bearer <token>" \
  http://localhost:8080/common/tasks/stats | jq '.Data[] | select(.name == "monthly_reset")'
```

### 4. å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# Docker æ–¹å¼
docker-compose down
git checkout <previous_commit>
docker-compose up -d

# ç‰©ç†æœºæ–¹å¼
cp core/mysql.go.backup core/mysql.go
go build -o trojan .
cp trojan /usr/local/bin/trojan
systemctl restart trojan-web

# æ¢å¤æ•°æ®åº“ï¼ˆå¦‚éœ€è¦ï¼‰
mysql -u root -p trojan < trojan_backup_YYYYMMDD.sql
```

---

## ğŸ“Š æ€§èƒ½å½±å“åˆ†æ

### 1. SQL æŸ¥è¯¢æ€§èƒ½

**ä¿®å¤å‰**:
```sql
SELECT * FROM users WHERE useDays != 0 AND quota != 0
```
- éœ€è¦æ£€æŸ¥ä¸¤ä¸ªå­—æ®µæ¡ä»¶
- å‡è®¾æœ‰ç´¢å¼•ï¼šå¿«é€Ÿ

**ä¿®å¤å**:
```sql
SELECT * FROM users WHERE quota != 0
```
- åªæ£€æŸ¥ä¸€ä¸ªå­—æ®µæ¡ä»¶
- æŸ¥è¯¢èŒƒå›´å¯èƒ½æ‰©å¤§ï¼ˆå¢åŠ  useDays=0 çš„ç”¨æˆ·ï¼‰
- **æ€§èƒ½å½±å“**: å¿½ç•¥ä¸è®¡ï¼ˆå•æ¡ä»¶æŸ¥è¯¢æ›´å¿«ï¼‰

### 2. æ‰¹é‡æ›´æ–°æ€§èƒ½

å‡è®¾ç³»ç»Ÿæœ‰ 1000 ä¸ªç”¨æˆ·ï¼š
- ä¿®å¤å‰ï¼š500 ä¸ªé™æœŸç”¨æˆ·ï¼ˆuseDays != 0ï¼‰
- ä¿®å¤åï¼š800 ä¸ªæœ‰é™é¢ç”¨æˆ·ï¼ˆquota != 0ï¼‰

**æ€§èƒ½å¯¹æ¯”**:
| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | å˜åŒ– |
|------|--------|--------|------|
| æŸ¥è¯¢ç”¨æˆ·æ•° | 500 | 800 | +60% |
| UPDATE è¯­å¥ | 1 æ¬¡ | 1 æ¬¡ | æ— å˜åŒ– |
| æ‰§è¡Œæ—¶é—´ | ~10ms | ~15ms | +50% |
| å½±å“ | å¿½ç•¥ä¸è®¡ | å¿½ç•¥ä¸è®¡ | âœ… å¯æ¥å— |

**ç»“è®º**: æ€§èƒ½å½±å“å¯å¿½ç•¥ä¸è®¡ï¼Œæ‰¹é‡æ›´æ–°ä¼˜åŒ–ç¡®ä¿å³ä½¿ç”¨æˆ·æ•°å¢åŠ ä¹Ÿåªæ‰§è¡Œä¸€æ¬¡ SQLã€‚

---

## ğŸ¯ é•¿æœŸæ”¹è¿›å»ºè®®

### 1. æ•°æ®åº“è¡¨ç»“æ„ä¼˜åŒ–

è€ƒè™‘æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ï¼š

```sql
-- ä¸º quota å­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX idx_users_quota ON users(quota);

-- ä¸º useDays å­—æ®µæ·»åŠ ç´¢å¼•ï¼ˆç”¨äºè¿‡æœŸæ£€æŸ¥ï¼‰
CREATE INDEX idx_users_useDays ON users(useDays);
```

### 2. å¢å¼ºæ—¥å¿—è®°å½•

åœ¨ `MonthlyResetData()` ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š

```go
func (mysql *Mysql) MonthlyResetData() error {
    // ...
    log.Printf("[MonthlyReset] Found %d users with quota to reset", len(userList))
    
    if len(userList) > 0 {
        // ...
        log.Printf("[MonthlyReset] Successfully reset traffic for %d users", len(ids))
    } else {
        log.Println("[MonthlyReset] No users need traffic reset")
    }
    // ...
}
```

### 3. æ·»åŠ ç›‘æ§å‘Šè­¦

å»ºè®®æ·»åŠ ä»¥ä¸‹ç›‘æ§æŒ‡æ ‡ï¼š

| æŒ‡æ ‡ | è¯´æ˜ | å‘Šè­¦æ¡ä»¶ |
|------|------|---------|
| é‡ç½®ç”¨æˆ·æ•° | æ¯æ¬¡é‡ç½®çš„ç”¨æˆ·æ•°é‡ | çªç„¶é™ä¸º 0 |
| ä»»åŠ¡æ‰§è¡Œæ—¶é—´ | MonthlyResetData æ‰§è¡Œè€—æ—¶ | > 10 ç§’ |
| ä»»åŠ¡å¤±è´¥æ¬¡æ•° | é‡ç½®ä»»åŠ¡å¤±è´¥è®¡æ•° | > 0 |
| ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ | ç¡®ä¿ä»»åŠ¡æ­£å¸¸è°ƒåº¦ | æ—¶é—´é”™è¯¯ |

### 4. ç”¨æˆ·ç•Œé¢ä¼˜åŒ–

åœ¨ç®¡ç†åå°æ·»åŠ æµé‡é‡ç½®ç›¸å…³ä¿¡æ¯ï¼š

```
æµé‡é‡ç½®é…ç½®
â”œâ”€ é‡ç½®æ—¥: æ¯æœˆ 1 å·
â”œâ”€ ä¸‹æ¬¡é‡ç½®: 2025-11-01 00:00:00
â”œâ”€ ä¸Šæ¬¡é‡ç½®: 2025-10-01 00:00:00
â”œâ”€ é‡ç½®ç”¨æˆ·æ•°: 856
â””â”€ æ‰§è¡ŒçŠ¶æ€: âœ… æˆåŠŸ
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

### æ ¸å¿ƒæ–‡æ¡£
- [å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨](../TASK_SCHEDULER.md) - ç»Ÿä¸€ä»»åŠ¡è°ƒåº¦æœºåˆ¶
- [æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š](../performance-optimization/PERFORMANCE_OPTIMIZATION_REPORT.md) - æ‰¹é‡æ›´æ–°ä¼˜åŒ–
- [Docker éƒ¨ç½²æŒ‡å—](../DOCKER_DEPLOYMENT.md) - Docker ç¯å¢ƒéƒ¨ç½²

### æµ‹è¯•æ–‡æ¡£
- [test-monthly-reset.sh](../../scripts/test-monthly-reset.sh) - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- [å®šæ—¶ä»»åŠ¡æµ‹è¯•æŒ‡å—](../refactor/CRON_TESTING.md) - å®šæ—¶ä»»åŠ¡æµ‹è¯•æ–¹æ³•

### API æ–‡æ¡£
- `GET /trojan/data/resetDay` - è·å–æµé‡é‡ç½®æ—¥é…ç½®
- `POST /trojan/data/resetDay` - ä¿®æ”¹æµé‡é‡ç½®æ—¥é…ç½®
- `GET /common/tasks/stats` - è·å–å®šæ—¶ä»»åŠ¡ç»Ÿè®¡

---

## ğŸ“Œ æäº¤ä¿¡æ¯

**Commit**: `<å¾…æäº¤>`
**Date**: 2025-10-08
**Files**:
- `core/mysql.go` - ä¿®å¤ MonthlyResetData SQL æŸ¥è¯¢æ¡ä»¶
- `scripts/test-monthly-reset.sh` - æ–°å¢è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
- `docs/fixes/MONTHLY_RESET_FIX.md` - è¯¦ç»†ä¿®å¤æ–‡æ¡£

**Git æ—¥å¿—**:
```
fix: ä¿®å¤æµé‡æœˆåº¦è‡ªåŠ¨é‡ç½®åŠŸèƒ½

é—®é¢˜æè¿°:
ç”¨æˆ·æµé‡ç”¨é‡æ¯æœˆè‡ªåŠ¨é‡ç½®åŠŸèƒ½ä¸æ­£å¸¸ï¼Œéƒ¨åˆ†ç”¨æˆ·ï¼ˆuseDays=0ï¼‰çš„æµé‡
ä¸ä¼šè¢«é‡ç½®ã€‚

æ ¹æœ¬åŸå› :
MonthlyResetData() çš„ SQL æŸ¥è¯¢æ¡ä»¶é”™è¯¯ï¼š
  WHERE useDays != 0 AND quota != 0
å¯¼è‡´åªæœ‰è®¾ç½®äº†æœ‰æ•ˆæœŸçš„ç”¨æˆ·æµé‡æ‰ä¼šè¢«é‡ç½®ï¼Œæ°¸ä¹…ç”¨æˆ·ï¼ˆuseDays=0ï¼‰
çš„æµé‡æ°¸è¿œä¸ä¼šé‡ç½®ã€‚

è§£å†³æ–¹æ¡ˆ:
ä¿®æ”¹ SQL æŸ¥è¯¢æ¡ä»¶ä¸ºï¼š
  WHERE quota != 0
æœˆåº¦æµé‡é‡ç½®åº”è¯¥é’ˆå¯¹æ‰€æœ‰æœ‰æµé‡é™é¢çš„ç”¨æˆ·ï¼Œä¸åº”è¯¥ä¾èµ– useDays å­—æ®µã€‚

å½±å“ç”¨æˆ·:
- useDays = 0 ä¸” quota != 0 çš„æ°¸ä¹…ç”¨æˆ·ï¼ˆä¿®å¤åæµé‡ä¼šæ­£å¸¸é‡ç½®ï¼‰

æµ‹è¯•æ–¹æ³•:
./scripts/test-monthly-reset.sh http://localhost:8080 admin password

Related: #monthly-reset #traffic #quota
```

---

## ğŸ‰ æ€»ç»“

### ä¿®å¤æˆæœ
- âœ… ä¿®å¤äº†æµé‡æœˆåº¦è‡ªåŠ¨é‡ç½®çš„ SQL æŸ¥è¯¢æ¡ä»¶
- âœ… ç¡®ä¿æ‰€æœ‰æœ‰æµé‡é™é¢çš„ç”¨æˆ·ï¼ˆåŒ…æ‹¬æ°¸ä¹…ç”¨æˆ·ï¼‰æµé‡ä¼šè¢«é‡ç½®
- âœ… æä¾›è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬éªŒè¯ä¿®å¤æ•ˆæœ
- âœ… æ— æ€§èƒ½å½±å“ï¼ˆæŸ¥è¯¢æ¡ä»¶æ›´ç®€å•ï¼‰
- âœ… å®Œæ•´çš„æ–‡æ¡£å’Œæµ‹è¯•è¦†ç›–

### æŠ€æœ¯æ”¶è·
1. **ä¸šåŠ¡é€»è¾‘ç†è§£**: æœ‰æ•ˆæœŸï¼ˆuseDaysï¼‰å’Œæµé‡é™é¢ï¼ˆquotaï¼‰æ˜¯ç‹¬ç«‹çš„æ¦‚å¿µ
2. **SQL æ¡ä»¶è®¾è®¡**: æŸ¥è¯¢æ¡ä»¶åº”è¯¥ç²¾ç¡®åæ˜ ä¸šåŠ¡éœ€æ±‚
3. **æµ‹è¯•é©±åŠ¨ä¿®å¤**: å…ˆåˆ†æé—®é¢˜ï¼Œå†ä¿®å¤ï¼Œå†éªŒè¯
4. **å‘åå…¼å®¹**: ä¿®å¤ä¸ä¼šå½±å“åŸæœ¬å·¥ä½œæ­£å¸¸çš„åŠŸèƒ½

### åç»­å»ºè®®
1. **ç›‘æ§**: æ·»åŠ æµé‡é‡ç½®æ‰§è¡Œç»“æœç›‘æ§
2. **æ—¥å¿—**: å¢å¼ºæ—¥å¿—è®°å½•ï¼Œè®°å½•é‡ç½®ç”¨æˆ·æ•°å’Œæ‰§è¡Œæ—¶é—´
3. **å‘Šè­¦**: é‡ç½®ä»»åŠ¡å¤±è´¥æ—¶è‡ªåŠ¨å‘Šè­¦
4. **æ–‡æ¡£**: æ›´æ–°ç”¨æˆ·æ‰‹å†Œï¼Œè¯´æ˜æµé‡é‡ç½®æœºåˆ¶

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-08  
**ç»´æŠ¤è€…**: Trojan Team
